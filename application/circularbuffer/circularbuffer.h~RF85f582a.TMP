#pragma once
#include <QObject>
#include <iostream>
#include "circularbufferreader.h"
#include "dbglogger.h"
class CircularBufferReader;
class NodeInfoViewer;

enum ResizeOperationState_t
{
    NO_OPERATION,
    STARTED
};

class CircularBuffer
{
private:
    DbgLogger* dbgLogger = nullptr;
    char* data;//the pointer to the begin of the buffer

    char* originalBuffer = nullptr;
    char* resizeBufferData = nullptr;
    int head;
    int iterations = 0;
    int capacity;
    int maxCapacity;
    bool historicalCapable;

    int minTail = 0;
    int minTailIteration = 0;

    ResizeOperationState_t resizeOperation = NO_OPERATION;
    void checkSize(int neededSize);
    void returnToBegin();
public:
    CircularBuffer(DbgLogger *dbgLogger, const int _capacity = 1000, const  int _maxCapacity = 1000, bool historicalCapable = false);
    ~CircularBuffer();
    //todo copy and move constructor
    int usedSize(CircularBufferReader *reader);
    int unUsedSize(CircularBufferReader *reader);

    void append(char *inputData, int size);//prefered
    void append(const QByteArray *data);
    void appendByte(char *inputData);

    int getSize();

    void resetTail();
    void calcTail(CircularBufferReader *reader);
    int unUsedSize();

    void print();
    void reset();
    CircularBufferReader *requestNewReader();

    bool isHistoricalCapable() const;

    friend CircularBufferReader;
    friend NodeInfoViewer;
    int resize(int newCapacity);
};


